# é‰´å®ç®¡ç†åå° - Pythonåç«¯æœåŠ¡éƒ¨ç½²æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°
- **é¡¹ç›®ç±»å‹**: Python FastAPIåç«¯æœåŠ¡
- **å›¢é˜Ÿè§„æ¨¡**: 20äººä»¥å†…
- **DAU**: 50äººï¼ˆç®¡ç†åå°ï¼‰
- **æ ¸å¿ƒåŠŸèƒ½**: å›¾ç‰‡è§†é¢‘å¤„ç†ã€ä¸šåŠ¡APIæœåŠ¡
- **æŠ€æœ¯æ ˆ**: Python FastAPI + SQLAlchemy + MySQL + Redis
- **éƒ¨ç½²é¢‘ç‡**: æ¯å‘¨è‡³å°‘1æ¬¡

## ğŸ—ï¸ åç«¯æœåŠ¡æ¶æ„

```
APIç½‘å…³ â†’ è´Ÿè½½å‡è¡¡ â†’ FastAPIæœåŠ¡é›†ç¾¤ â†’ æ•°æ®åº“é›†ç¾¤
    â†“         â†“           â†“              â†“
  é™æµ     åˆ†å‘è¯·æ±‚    ä¸šåŠ¡é€»è¾‘å¤„ç†    æ•°æ®æŒä¹…åŒ–
    â†“         â†“           â†“              â†“
CDNåŠ é€Ÿ   å¥åº·æ£€æŸ¥    å¼‚æ­¥ä»»åŠ¡å¤„ç†   Redisç¼“å­˜
```

## ğŸ’° æˆæœ¬é¢„ä¼°ï¼ˆåç«¯æœåŠ¡ï¼‰

### æŒ‰é‡ä»˜è´¹é…ç½®ï¼ˆçµæ´»æˆæœ¬æ§åˆ¶ï¼‰

#### ğŸ’¡ å…¨å¤©å€™è¿è¡Œï¼ˆ24å°æ—¶/å¤©ï¼‰
| æœåŠ¡ç»„ä»¶ | é…ç½®è§„æ ¼ | æŒ‰é‡ä»·æ ¼ | æœˆæˆæœ¬(720å°æ—¶) | è¯´æ˜ |
|---------|---------|---------|---------------|------|
| **TKEèŠ‚ç‚¹** | 2èŠ‚ç‚¹Ã—2C4G | 0.4å…ƒ/å°æ—¶/èŠ‚ç‚¹ | 576å…ƒ | FastAPIæœåŠ¡è¿è¡Œ |
| **MySQL** | 2C4Gå•èŠ‚ç‚¹ | 0.5å…ƒ/å°æ—¶ | 360å…ƒ | ä¸šåŠ¡æ•°æ®å­˜å‚¨ |
| **Redis** | 1Gæ ‡å‡†ç‰ˆ | 0.12å…ƒ/å°æ—¶ | 86å…ƒ | ç¼“å­˜å’Œä¼šè¯ |
| **COSå­˜å‚¨** | 50GB | 0.118å…ƒ/GB/æœˆ | 6å…ƒ | æ–‡ä»¶å­˜å‚¨ |
| **CLBè´Ÿè½½å‡è¡¡** | æ ‡å‡†ç‰ˆ | 0.02å…ƒ/å°æ—¶ | 14å…ƒ | æœåŠ¡è´Ÿè½½å‡è¡¡ |
| **ç½‘ç»œæµé‡** | æŒ‰å®é™…ä½¿ç”¨ | çº¦1å…ƒ/GB | 20å…ƒ | é¢„ä¼°20GB/æœˆ |
| **å°è®¡** | | | **1062å…ƒ/æœˆ** | å…¨å¤©å€™è¿è¡Œ |

#### ğŸ• å·¥ä½œæ—¶é—´è¿è¡Œï¼ˆ12å°æ—¶/å¤©ï¼Œä»…å·¥ä½œæ—¥ï¼‰
| è¿è¡Œæ¨¡å¼ | æœˆè¿è¡Œæ—¶é•¿ | æœˆæˆæœ¬ | èŠ‚çœ |
|---------|------------|-------|------|
| **å¼€å‘ç¯å¢ƒ** | 12å°æ—¶/å¤© Ã— 22å·¥ä½œæ—¥ = 264å°æ—¶ | **390å…ƒ** | èŠ‚çœ672å…ƒ |
| **æµ‹è¯•ç¯å¢ƒ** | 8å°æ—¶/å¤© Ã— 22å·¥ä½œæ—¥ = 176å°æ—¶ | **260å…ƒ** | èŠ‚çœ802å…ƒ |
| **ç”Ÿäº§ç¯å¢ƒ** | 24å°æ—¶/å¤© Ã— 30å¤© = 720å°æ—¶ | **1062å…ƒ** | æŒ‰éœ€è¿è¡Œ |

### æ‰©å®¹é…ç½®ï¼ˆä¸šåŠ¡å¢é•¿ï¼‰
| æœåŠ¡ç»„ä»¶ | é…ç½®è§„æ ¼ | æœˆæˆæœ¬ | è¯´æ˜ |
|---------|---------|-------|------|
| **TKEé›†ç¾¤** | 5èŠ‚ç‚¹Ã—4C8G | 1200å…ƒ | é«˜å¹¶å‘æ”¯æŒ |
| **MySQL** | 4C8GåŒèŠ‚ç‚¹ | 380å…ƒ | ä¸»ä»å¤åˆ¶ |
| **Redis** | 2Gé›†ç¾¤ç‰ˆ | 120å…ƒ | é«˜å¯ç”¨ç¼“å­˜ |
| **å…¶ä»–ç»„ä»¶** | æ‰©å®¹é…ç½® | 300å…ƒ | ç›‘æ§ã€å­˜å‚¨ç­‰ |
| **æ€»è®¡** | | **2000å…ƒ/æœˆ** | |

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

### 1. FastAPIåç«¯æœåŠ¡
- **é«˜æ€§èƒ½**: å¼‚æ­¥å¤„ç†ï¼Œæ”¯æŒé«˜å¹¶å‘
- **è‡ªåŠ¨æ–‡æ¡£**: Swagger UIè‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£
- **ç±»å‹å®‰å…¨**: Pydanticæ•°æ®éªŒè¯
- **æ˜“æ‰©å±•**: æ¨¡å—åŒ–æ¶æ„è®¾è®¡

### 2. å›¾ç‰‡è§†é¢‘å¤„ç†èƒ½åŠ›
- **å¼‚æ­¥å¤„ç†**: Celery + Redisé˜Ÿåˆ—
- **æ™ºèƒ½å‹ç¼©**: PIL/OpenCVå›¾ç‰‡å¤„ç†
- **è§†é¢‘è½¬ç **: FFmpegè§†é¢‘å¤„ç†
- **COSé›†æˆ**: è‡ªåŠ¨ä¸Šä¼ è…¾è®¯äº‘å­˜å‚¨

### 3. åŸºç¡€éƒ¨ç½²é…ç½®
- **å›ºå®šå‰¯æœ¬**: 2ä¸ªPodå®ä¾‹ä¿è¯åŸºæœ¬å¯ç”¨æ€§
- **æ»šåŠ¨æ›´æ–°**: é›¶åœæœºéƒ¨ç½²æ›´æ–°
- **èµ„æºé™åˆ¶**: åˆç†çš„èµ„æºé…ç½®é¿å…æµªè´¹

### 4. ç›‘æ§å‘Šè­¦
- **æœåŠ¡ç›‘æ§**: APIå“åº”æ—¶é—´ã€é”™è¯¯ç‡
- **èµ„æºç›‘æ§**: CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡
- **ä¸šåŠ¡ç›‘æ§**: æ–‡ä»¶å¤„ç†æˆåŠŸç‡
- **å‘Šè­¦é€šçŸ¥**: ä¼ä¸šå¾®ä¿¡ç¾¤é€šçŸ¥

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
jianbao-backend-deployment/
â”œâ”€â”€ README.md                    # é¡¹ç›®æ¦‚è¿°
â”œâ”€â”€ .env.example                # åç«¯ç¯å¢ƒé…ç½®
â”œâ”€â”€ .coding-ci.yml              # ğŸ”¥ CODING DevOpsæµæ°´çº¿é…ç½®
â”œâ”€â”€ Dockerfile                  # FastAPIæœåŠ¡é•œåƒ
â”œâ”€â”€ docker-entrypoint.sh        # å®¹å™¨å¯åŠ¨è„šæœ¬
â”œâ”€â”€ requirements.txt            # Pythonä¾èµ–
â”œâ”€â”€ k8s/                        # Kubernetesé…ç½®
â”‚   â”œâ”€â”€ deployment.yaml         # åç«¯æœåŠ¡éƒ¨ç½²
â”‚   â”œâ”€â”€ service.yaml           # æœåŠ¡æš´éœ²é…ç½®
â”‚   â””â”€â”€ configmap.yaml         # é…ç½®ç®¡ç†
â”œâ”€â”€ infrastructure/             # åŸºç¡€è®¾æ–½
â”‚   â”œâ”€â”€ secrets.yaml           # å¯†é’¥ç®¡ç†
â”‚   â””â”€â”€ ingress.yaml           # è´Ÿè½½å‡è¡¡
â”œâ”€â”€ scripts/                   # éƒ¨ç½²è„šæœ¬
â”‚   â”œâ”€â”€ deploy-backend.sh      # åç«¯æœåŠ¡éƒ¨ç½²
â”‚   â””â”€â”€ cost-control.sh        # æˆæœ¬æ§åˆ¶
â””â”€â”€ docs/                      # éƒ¨ç½²æ–‡æ¡£
    â”œâ”€â”€ coding-devops-setup.md  # ğŸ”¥ CODING DevOpsé…ç½®æŒ‡å—
    â”œâ”€â”€ cicd-options.md         # CI/CDæœåŠ¡å¯¹æ¯”
    â””â”€â”€ cost-optimization.md    # æˆæœ¬ä¼˜åŒ–æŒ‡å—
```

## ğŸ”§ æŠ€æœ¯æ ˆè¯¦æƒ…

### åç«¯æœåŠ¡
- **Framework**: FastAPI 0.104+
- **ASGI Server**: Uvicorn
- **ORM**: SQLAlchemy 2.0
- **Migration**: Alembic
- **Task Queue**: Celery + Redis
- **Cache**: Redis
- **Database**: MySQL 8.0

### å®¹å™¨åŒ–
- **Container**: Docker
- **Orchestration**: Kubernetes (TKE)
- **Registry**: è…¾è®¯äº‘å®¹å™¨é•œåƒæœåŠ¡ TCR
- **Storage**: è…¾è®¯äº‘å¯¹è±¡å­˜å‚¨ COS

### ç›‘æ§è¿ç»´
- **Metrics**: Prometheus
- **Visualization**: Grafana
- **Logging**: ELK Stack
- **Alerting**: AlertManager + ä¼ä¸šå¾®ä¿¡

## ğŸš€ éƒ¨ç½²æ–¹æ¡ˆé€‰æ‹©

### ğŸ¯ **æ–¹æ¡ˆä¸€ï¼šGitHub Actions + ArgoCDï¼ˆæ¨èï¼‰**

**ç°ä»£åŒ–GitOps CI/CDæµæ°´çº¿ï¼Œæ›¿ä»£å³å°†ä¸‹çº¿çš„CODING DevOpsï¼š**

```bash
# 1. å¿«é€Ÿéƒ¨ç½²ArgoCD
chmod +x scripts/deploy-argocd.sh
./scripts/deploy-argocd.sh

# 2. é…ç½®Secretså’Œæƒé™
kubectl apply -f k8s/secrets.yaml
kubectl apply -f k8s/serviceaccount.yaml

# 3. åˆ›å»ºArgoCDåº”ç”¨
kubectl apply -f argocd/application.yaml
```

**ğŸ”¥ æ ¸å¿ƒä¼˜åŠ¿ï¼š**
- âœ… **GitHub Actions**: ä»£ç æ£€æŸ¥ â†’ æ„å»ºé•œåƒ â†’ æ¨é€TCR
- âœ… **ArgoCD**: æ£€æµ‹å˜æ›´ â†’ è‡ªåŠ¨éƒ¨ç½² â†’ çŠ¶æ€ç›‘æ§  
- âœ… **GitOps**: å£°æ˜å¼é…ç½® + è‡ªåŠ¨åŒæ­¥
- âœ… **é›¶åœæœº**: æ»šåŠ¨æ›´æ–° + è‡ªåŠ¨å›æ»š
- âœ… **å…è´¹**: GitHub Actionså…è´¹é¢åº¦ + ArgoCDå¼€æº

ğŸ“– **å®Œæ•´é…ç½®æŒ‡å—**: [GitHub Actions + ArgoCD è®¾ç½®æ–‡æ¡£](docs/github-actions-argocd-setup.md)

---

### ğŸ”§ **æ–¹æ¡ˆäºŒï¼šCODING DevOpsï¼ˆå³å°†ä¸‹çº¿ï¼‰**

âš ï¸ **é‡è¦æé†’**: CODING DevOpså°†äº2025å¹´9æœˆ1æ—¥ä¸‹çº¿æ ‡å‡†ç‰ˆï¼Œå»ºè®®è¿ç§»åˆ°æ–¹æ¡ˆä¸€ã€‚

### 1. ç¯å¢ƒå‡†å¤‡
```bash
# é…ç½®åç«¯ç¯å¢ƒå˜é‡
cp .env.example .env
vim .env  # å¡«å…¥æ•°æ®åº“ã€Redisã€COSé…ç½®

# ç¡®è®¤æŒ‰é‡ä»˜è´¹æ¨¡å¼
echo "BILLING_MODE=POSTPAID_BY_HOUR" >> .env
```

### 2. é…ç½®CODING DevOps
```bash
# è¿è¡Œé…ç½®å‘å¯¼ï¼ˆäº¤äº’å¼ï¼‰
chmod +x scripts/setup-coding.sh
./scripts/setup-coding.sh

# æˆ–ä½¿ç”¨è‡ªåŠ¨é…ç½®ï¼ˆéäº¤äº’ï¼‰
./scripts/setup-coding.sh --auto

# è®¿é—®CODINGåˆ›å»ºé¡¹ç›®
# https://coding.net
# æŒ‰ç…§ç”Ÿæˆçš„æŒ‡å—é…ç½®é¡¹ç›®
```

### 3. è‡ªåŠ¨åŒ–éƒ¨ç½²
```bash
# æ¨é€åˆ°developåˆ†æ”¯ â†’ è‡ªåŠ¨éƒ¨ç½²æµ‹è¯•ç¯å¢ƒ
git push origin develop

# æ¨é€åˆ°mainåˆ†æ”¯ â†’ è‡ªåŠ¨éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ  
git push origin main

# åœ¨CODINGæŸ¥çœ‹æ„å»ºè¿‡ç¨‹å’Œéƒ¨ç½²æ—¥å¿—
```

### 4. æˆæœ¬ç›‘æ§è®¾ç½®
```bash
# è®¾ç½®è´¹ç”¨å‘Šè­¦ï¼ˆæ—¥è´¹ç”¨è¶…è¿‡50å…ƒæ—¶å‘Šè­¦ï¼‰
tccli billing CreateBudget \
  --BudgetName "jianbao-daily-budget" \
  --BudgetValue 50 \
  --TimeUnit "daily"
```

### 5. éªŒè¯å’Œç›‘æ§
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
kubectl get pods -n jianbao-system
curl https://api.jianbao.com/health

# æŸ¥çœ‹å½“å‰è´¹ç”¨
tccli billing DescribeBillSummaryByProduct --PayerUin your-uin
```

## ğŸ“Š æœåŠ¡ç›‘æ§

### å…³é”®æŒ‡æ ‡
- **APIå“åº”æ—¶é—´**: P95 < 200ms
- **æœåŠ¡å¯ç”¨æ€§**: >99.9%
- **é”™è¯¯ç‡**: <0.1%
- **å¤„ç†ååé‡**: >1000 req/s
- **æ–‡ä»¶å¤„ç†**: å›¾ç‰‡<5sï¼Œè§†é¢‘<30s

### ç›‘æ§é¢æ¿
- **æœåŠ¡æ¦‚è§ˆ**: è¯·æ±‚é‡ã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡
- **èµ„æºç›‘æ§**: CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨
- **ä¸šåŠ¡ç›‘æ§**: ç”¨æˆ·æ´»è·ƒåº¦ã€æ–‡ä»¶å¤„ç†é‡
- **å‘Šè­¦ä¸­å¿ƒ**: å®æ—¶å‘Šè­¦çŠ¶æ€å’Œå†å²

é€šè¿‡ä»¥ä¸Šé…ç½®ï¼Œæ‚¨çš„Pythonåç«¯æœåŠ¡å¯ä»¥ç¨³å®šæ”¯æ’‘50 DAUçš„ç®¡ç†åå°ï¼Œå¹¶å…·å¤‡å¤„ç†å¤§è§„æ¨¡å›¾ç‰‡è§†é¢‘çš„èƒ½åŠ›ï¼